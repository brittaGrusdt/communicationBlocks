---
title: "Analysis Pilot CommunicationBlocks Experiment"
output: html_notebook
---

```{r, packages, message=F}
library(here)
library(tidyverse)
library(dplyr)
source(here("R", "utils.R"))
theme_set(theme_bw(base_size=12) + theme(legend.position = "top"))
```

```{r, message=FALSE, warning=FALSE}
fn <- "results_67_communicationBlocks_BG_pilot.csv"
data <- read_csv(here("results", fn)) %>% as_tibble() %>%
  group_by(submission_id)
```

## Meta information about participants

```{r, meta, echo=FALSE}
data.meta <- data %>% distinct_at(vars(c(submission_id)), .keep_all = T) %>%
  mutate(education=as_factor(education), gender=as_factor(gender))

data.meta$gender %>% summary()
data.meta$education %>% summary()
data.meta$age %>% summary()
data.meta$timeSpent %>% summary()
```

## Reaction times

```{r, timespent, message=FALSE}
data.rt <- data %>% select(expected, RT, id, question, trial_name, type, timeSpent)
data.rt %>%
  ggplot(aes(x=id, y=RT)) + 
  geom_jitter(aes(color=question), width=0.2, height=0) +
  geom_boxplot(outlier.shape=NA) +
  theme(axis.text.x=element_text(angle=90), legend.position = "right") +
  facet_wrap(~type, scales="free_x")
```

## General comments all participants

```{r}
data %>% select(comments) %>%  filter(!is.na(comments) & comments!="") %>% 
  distinct()
```

## Training Trials

```{r}
data.train = data %>% filter(type=="training") %>%
  mutate(correct=case_when(expected == response ~ T, T ~ F))

# ratio correct per trial number (different order per participant)
train.correct.nb = data.train %>% group_by(trial_number) %>% 
  summarize(ratio_correct = mean(correct))
train.correct.nb %>% 
  ggplot(aes(x=trial_number, y=ratio_correct)) + 
  geom_bar(stat="identity") + 
  scale_x_continuous(breaks=seq(1, 7))

# ratio correct per trial id
train.correct.id = data.train %>% group_by(id) %>% 
  summarize(ratio_correct = mean(correct))
train.correct.id %>% 
  ggplot(aes(x=id, y=ratio_correct)) + 
  geom_bar(stat="identity") +
  theme(axis.text.x=element_text(angle=90))
```

## Example Test-Trial

```{r}
data.example_test = data %>% filter(type=="test-example") %>%
  group_by(submission_id) %>% 
  dplyr::select(expected, selected_pic) %>% 
  transmute(correct = expected == selected_pic)

rate_correct_example = data.example_test %>%
  summarize(ratio_correct = sum(correct) / n()) %>% 
  pull(ratio_correct)

ids.wrong = data.example_test %>% filter(!correct) %>% pull(submission_id) %>% 
  unique()
ids.wrong
```


## Test trials

Look at control test trials

```{r, message=FALSE}
data.control = data %>% filter(startsWith(type,"control")) %>% 
  mutate(correct = expected == selected_pic) %>% 
  group_by(id, type) %>%
  mutate(n=n(), n_correct = sum(correct), ratio_correct = n_correct/n) %>% 
  dplyr::select(c(id, type, n, n_correct, ratio_correct)) %>%
  distinct_at(vars(c(id, type)), .keep_all = T)
    
data.control %>% 
  ggplot(aes(x=ratio_correct, y=id)) + 
  geom_bar(aes(fill=type), stat="identity") +
  labs(x="ratio correct", title="control test trials", y="")
```

Clean data

```{r}
n_all = data$submission_id %>% unique() %>% length
data.cleaned = clean_data(data)
n_kept = data.cleaned$submission_id %>% unique() %>% length

ratio_kept = round(n_kept/n_all, 2)
```

Data from `r ratio_kept` of all participants is retained.

## Plot critical trials

```{r, data-critical}
data.critical = data.cleaned %>% 
  filter(type=="critical") %>% 
  select(submission_id, id, type, question, response, expected, id1, id2,
         selected_pic) %>% 
  mutate(expectation = case_when(expected == "none" ~ FALSE,
                                 TRUE ~ TRUE)) %>%
  group_by(id1, id2)

data.critical$pic_combi = data.critical %>% group_indices()
data.critical <- data.critical %>% 
  mutate(pic_combi=paste(id1, id2, sep=" & ")) %>% 
  group_by(pic_combi, question) %>% mutate(n=n()) 

data.critical.rate = data.critical %>% group_by(question) %>% 
  summarize(rate_exhaustive = sum(response == "exhaustive") / n(),
            .groups = "drop_last") 
data.critical.rate.pic_combi = data.critical %>% 
  group_by(question, pic_combi) %>% 
  summarize(rate_exhaustive = sum(response == "exhaustive") / n(),
            .groups="drop_last") 
```

### Trials we make predictions about

1. acrooss all

```{r}
conditions = configure(c("conditions"))
data.critical %>%
  ggplot(aes(fill=response, y=question)) + 
  geom_bar(position=position_dodge(preserve = 'single')) + 
  scale_y_discrete(breaks=names(conditions), labels = conditions) + 
  labs(y="Ann's question")

# same plot with ratios instead of absolute numbers
data.critical.rate %>%
  ggplot(aes(x=rate_exhaustive, y=question)) + 
  geom_bar(stat="identity") + 
  geom_text(aes(label=round(rate_exhaustive, 2)), hjust=1, color='white') +
  scale_y_discrete(breaks=names(conditions), labels = conditions) + 
  labs(y="Ann's question", x="selection rate exhaustive picture")
```

2. split among different instantiations of critical trials 
(i.e., across different picture combinations)

```{r}
data.critical.rate.pic_combi %>% 
  ggplot(aes(x=rate_exhaustive, y=question)) + 
  geom_bar(stat="identity") + 
  geom_text(aes(label=round(rate_exhaustive, 2)), hjust=1, color='white') +
  facet_wrap(~pic_combi)
```

