---
title: "analysis"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidybayes)
library(latex2exp)
library(here)
library(brms)
source(here("R", "utils.R"))
theme_set(theme_minimal(base_size=12) + theme(legend.position = "top"))

save_plots = FALSE
```

```{r, message=FALSE}
fn <- "results_67_communicationBlocks_BG.csv"
data.controls <- read_csv(here("results", fn)) %>% as_tibble() %>%
  group_by(submission_id) %>% 
  filter(startsWith(type, "control-") | type == "test-example") %>% 
  mutate(correct = expected == selected_pic) %>% 
  dplyr::select(correct, type, submission_id, prolific_id, id, timeSpent, comments, startDate) %>% 
  filter(!str_detect(prolific_id, "test-"))
```

## Attention-check for Prolific

Filter out participants who did not get attention checks right

```{r}
attention_checks = data.controls %>% filter(type=="control-random")
attention_checks %>% 
  group_by(id, type) %>%
  mutate(n=n(), n_correct = sum(correct), ratio_correct = n_correct/n) %>% 
  dplyr::select(c(id, type, n, n_correct, ratio_correct)) %>%
  distinct_at(vars(c(id, type)), .keep_all = T)

attention_checks.out = attention_checks %>%
  group_by(submission_id, prolific_id, timeSpent, comments, startDate) %>% 
  summarize(nb_correct = sum(correct), .groups = "drop_last") %>%
  filter(nb_correct != 3)

attention_checks.out %>% ungroup() %>%
  dplyr::select(prolific_id, nb_correct, startDate, comments) %>% arrange(nb_correct)
```

## Load cleaned data 

Data was cleaned (see script clean_data.R) according to predefined exclusion criteria

```{r, message=FALSE}
cleaned_data = read_csv(here("results", "data_cleaned.csv"))
```

## Meta information about participants

```{r, meta, echo=FALSE}
data.meta <- cleaned_data %>% 
  distinct_at(vars(c(submission_id)), .keep_all = T) %>%
  mutate(education=as_factor(education), gender=as_factor(gender))

data.meta$gender %>% summary()
data.meta$education %>% summary()
print("age:")
data.meta$age %>% summary()
print("timeSpent:")
data.meta$timeSpent %>% summary()
```

## Plot critical trials

```{r, data-critical, echo=FALSE}
data.critical = cleaned_data %>% 
  filter(type=="critical") %>% 
  select(submission_id, id, type, question, response, expected, id1, id2,
         selected_pic, RT) %>% 
  mutate(expectation = case_when(expected == "none" ~ FALSE,
                                 TRUE ~ TRUE)) %>%
  group_by(id1, id2)

data.critical$picPair = data.critical %>% group_indices()
data.critical <- data.critical %>% 
  mutate(picPair=paste(id1, id2, sep=" & "),
         picPair.short = case_when(picPair == "if2_unn & if2_unu" ~ "D. withDistractor-external", 
                                   picPair == "if1_un & if2_unu" ~ "B. w/oDistractor-external",
                                   picPair == "if1_un & if1_uu" ~ "A. w/oDistractor-internal",
                                   picPair == "if2_unn & if1_uu" ~ "C. withDistractor-internal")) %>% 
  group_by(picPair, question) %>% mutate(n=n()) %>% 
  mutate(y=case_when(response == "exhaustive" ~ 1, T ~ 0)) %>%
  group_by(picPair) %>% 
  mutate(group_id = cur_group_id(), 
         pics = chartr('1234', 'ABCD', group_id)) %>% 
  group_by(pics, question) %>%
  mutate(pics = as.factor(pics), 
         question = factor(question, levels = c("neutral", "ifp", "willq"))) %>%
  rename(submissionID = submission_id) %>% 
  unite("picPair.long", "pics", "picPair", sep=". ") %>% 
  dplyr::select(-group_id) %>% 
  rename(picPair = picPair.short) %>% 
  mutate(picPair = as.factor(picPair), picPair.short = picPair) %>%
  separate(picPair.short, into=c("picPair.short", "tmp"), sep="\\.") %>% 
  mutate(picPair.short = as.factor(picPair.short)) %>% 
  dplyr::select(-tmp)
```

With 95%-bootstrap confidence intervals

```{r, boostrap-samples, echo = FALSE}
N = 1000
n_participants = data.critical$submissionID %>% unique() %>% length()
df.all = data.critical %>% 
  dplyr::select(submissionID, picPair, picPair.long, question, response) %>% 
  group_by(picPair, question)

bootstrap_samples = group_map(df.all, function(df, df.group){
  bootstrap = map(seq(1, N), function(i){
    tibble(rate_exhaustive =
             sum(sample(df$response, n_participants, replace=T) == "exhaustive")/n_participants)
  }) %>% bind_rows() %>% 
    add_column(picPair = df.group$picPair, question = df.group$question) %>% 
    arrange(rate_exhaustive)
  
  CI.bounds = bootstrap_bounds(bootstrap)
  ci.low = bootstrap[CI.bounds[["low"]], ]$rate_exhaustive
  ci.up = bootstrap[CI.bounds[["up"]], ]$rate_exhaustive
  bootstrap %>% add_column(ci.low=ci.low, ci.up=ci.up)
}) %>% bind_rows() %>% group_by(picPair, question)

bootstraps.CI.question_pic = bootstrap_samples %>%
  dplyr::select(-rate_exhaustive) %>% 
  distinct()

# CIs bounds (indices) across picPairs (same for each question)
CI.bounds.question = bootstrap_samples %>%
  filter(question=="willq") %>%
  bootstrap_bounds()

df = bootstrap_samples %>% dplyr::select(-ci.low, -ci.up) %>%
  group_by(question) %>% arrange(rate_exhaustive)
bootstraps.CI.question = group_map(df, function(samples, grp) {
  ci.low = samples[CI.bounds.question[["low"]], ]$rate_exhaustive
  ci.up = samples[CI.bounds.question[["up"]], ]$rate_exhaustive
  samples %>% add_column(ci.low=ci.low, ci.up=ci.up, question=grp$question)
}) %>% bind_rows() %>%
  dplyr::select(-rate_exhaustive, -picPair) %>% distinct()
```

```{r, critical-data-rates, echo = FALSE}
data.critical.rate = data.critical %>% group_by(question) %>% 
  summarize(rate_exhaustive = sum(response == "exhaustive") / n(),
            .groups = "drop_last") 

data.critical.rate = left_join(
  data.critical.rate,
  bootstraps.CI.question, 
  by="question"
)

data.critical.rate.picPair = data.critical %>% 
  group_by(question, picPair, picPair.long) %>% 
  summarize(rate_exhaustive = sum(response == "exhaustive") / n(),
            .groups="drop_last") 
data.critical.rate.picPair <- left_join(
  data.critical.rate.picPair,
  bootstraps.CI.question_pic,
  by = c("question", "picPair")
)
```

1. across all different instantiations, i.e. exhaustive/non-exhaustive 
picture combinations

```{r}
conditions = configure(c("conditions"))
data.critical %>%
  ggplot(aes(fill=response, y=question)) + 
  geom_bar(position=position_dodge(preserve = 'single')) +
  scale_y_discrete(breaks=names(conditions), labels = conditions) + 
  labs(y="Ann's question")

# same plot with exhaustive-picture selection ratios instead of absolute numbers
data.critical.rate %>%
  ggplot(aes(x=rate_exhaustive, y=question)) + 
  geom_bar(stat="identity") + 
  geom_errorbar(aes(xmin=ci.low, xmax=ci.up)) +
  geom_text(aes(label=round(rate_exhaustive, 2)), hjust=1, color='white') +
  scale_y_discrete(breaks=names(conditions), labels = conditions) + 
  labs(y="Ann's question", x="selection rate exhaustive picture")
```

2. split among different instantiations of critical trials 
(i.e., across different picture combinations)

```{r}
p = data.critical.rate.picPair %>% 
  mutate(condition = factor(picPair), 
         question = as.character(question), 
         question = case_when(question == "willq" ~ "will-q",
                              question == "ifp" ~ "if-p", 
                              T ~ question),
         question = as.factor(question)) %>% 
  ggplot(aes(x=rate_exhaustive, y=question)) + 
  geom_bar(stat="identity") + 
  geom_errorbar(aes(xmin=ci.low, xmax=ci.up)) +
  #geom_vline(aes(xintercept= 0.5), color='green', linetype='dashed') +
  geom_text(aes(label=round(rate_exhaustive, 2)), hjust=1, color='white') +
  facet_wrap(~condition) + 
  #facet_wrap(~picPair.long) + 
  labs(x="selection rate exhaustive situation", y = "QUD")
p
if(save_plots) ggsave(here("results", "figs", "selection-rates.pdf"), p, width=7, height=4)
```

Goodness-of-fit 
When non-exhaustive situation is internal (left column in plot above), the selection of the non-exhaustive/exhaustive situation is substantially different from being uniform (50%-50%)? 

```{r}
x <- data.critical %>% mutate(picPair = as.character(picPair)) %>% 
  filter(startsWith(picPair, "A") | startsWith(picPair, "C")) %>%
  group_by(response) %>% dplyr::count()
chisq.test(x$n, p=c(0.5, 0.5))
```



## Bayesian regression model

```{r, results='hide'}
model_path = here("results", "brms-model-newlabels.rds")
data.critical.model = data.critical %>% rename(picPair.full = picPair,
                                               picPair = picPair.short)
if(file.exists(model_path)) {
  fit <- readRDS(model_path)
} else {
  fit <-
    brm(data = data.critical.model,
        family = bernoulli,
        y ~ 1 + picPair * question + (1 + picPair + question|submissionID),
        seed = 1)
  saveRDS(fit, file=model_path)
}
fixef(fit)
pp_check(fit)
mcmc_plot(fit)

pp_check(fit, type = "stat", stat = 'mean', nsamples = 100)
```

Testing our hypotheses

1. separately for each picture pair

```{r, regression-hypotheses}
h1 = hypothesis(fit, "questionifp < questionwillq", class = "b")
h2 = hypothesis(fit, "questionifp + picPairB:questionifp < questionwillq + picPairB:questionwillq", class = "b")
h3 = hypothesis(fit, "questionifp + picPairC:questionifp < questionwillq + picPairC:questionwillq", class = "b")
h4 = hypothesis(fit, "questionifp + picPairD:questionifp < questionwillq + picPairD:questionwillq", class = "b")

h1$hypothesis
h2$hypothesis
h3$hypothesis
h4$hypothesis
```

2. Across picture pairs

```{r}
samples = tidy_draws(fit) %>% 
  mutate(
    ifp_A = b_Intercept + b_questionifp,
    ifp_B = b_Intercept + b_questionifp + b_picPairB + `b_picPairB:questionifp`,
    ifp_C = b_Intercept + b_questionifp + b_picPairC + `b_picPairC:questionifp`,
    ifp_D = b_Intercept + b_questionifp + b_picPairD + `b_picPairD:questionifp`,
    willq_A = b_Intercept + b_questionwillq,
    willq_B = b_Intercept + b_questionwillq + b_picPairB + `b_picPairB:questionwillq`,
    willq_C = b_Intercept + b_questionwillq + b_picPairC + `b_picPairC:questionwillq`,
    willq_D = b_Intercept + b_questionwillq + b_picPairD + `b_picPairD:questionwillq`)

coeffs = samples %>% 
  transmute(questionifp = (ifp_A + ifp_B + ifp_C + ifp_D)/4,
            questionwillq = (willq_A + willq_B + willq_C + willq_D)/4) %>% 
  mutate(ifpsmaller = questionifp < questionwillq)

mean(coeffs$ifpsmaller)

means = coeffs %>% summarize(mean_ifp = mean(questionifp),
                             mean_willq = mean(questionwillq))


# cohen.d(coeffs$questionifp, coeffs$questionwillq)
p.mainquestion = coeffs %>% rowid_to_column() %>% 
  pivot_longer(cols=c(questionifp, questionwillq)) %>%
  ggplot(aes(x=name, y=value)) + 
  geom_boxplot() +
  # geom_point(aes(group=rowid), alpha=0.1, width=0.2, height=0) +
  # geom_line(aes(group=rowid), alpha=0.1) + 
  labs(x = "estimated coefficient", y = "posterior samples") +
  scale_x_discrete(labels = c(questionifp = parse(text=TeX("$\\hat{\\beta}_{if-p}$")), 
                              questionwillq = parse(text=TeX("$\\hat{\\beta}_{will-q}$"))))
if(save_plots) ggsave(here("results", "figs", "main-effect-question.pdf"), 
                      p.mainquestion, width=7, height=4)
```

Analysis with 3x2x2 design

```{r}
plot_empirical = function(data, exclude_neutral = TRUE) {
  df = data %>% group_by(submissionID, picPair) %>% 
    dplyr::select(submissionID, picPair, question, response) #%>% 
    # filter(question != "neutral")
  
  df.wide = df %>% 
    mutate(response = str_replace(response, "exhaustive", "exh"),
           response = str_replace(response, "non-exh", "nonExh")) %>% 
    pivot_wider(names_from = question, values_from = response) %>% 
    unite("response", neutral, ifp, willq, sep="_") %>% 
    group_by(picPair, response) %>% dplyr::count() %>% 
    mutate(response = factor(response, 
                             levels = c("nonExh_nonExh_exh", "nonExh_exh_nonExh",
                                        "nonExh_nonExh_nonExh", "nonExh_exh_exh",
                                        "exh_nonExh_exh", "exh_exh_nonExh",
                                        "exh_nonExh_nonExh", "exh_exh_exh"),
                             labels = c("n/n/e", "n/e/n", "n/n/n", "n/e/e", 
                                        "e/n/e", "e/e/n", "e/n/n", "e/e/e")),
           stimulus = picPair) %>% 
    separate(picPair, into = c("exh", "nonExh"), sep = 1) %>% 
    mutate(exh = case_when(exh == "I" ~ "internal", T ~ "external"),
           nonExh = case_when(nonExh == "I" ~ "internal", T ~ "external")) %>% 
    group_by(stimulus) %>% mutate(N=sum(n), ratio=n/N)
  xlab = "selected situation for QUDs neutral/if-p/will-q"
  
  if(exclude_neutral) {
    df.wide <- df.wide %>% 
      separate(response, into=c("neutral", "response"), sep=2) %>% 
      group_by(stimulus, response) %>% 
      summarize(n=sum(n), N=N, ratio=n/N) %>% 
      mutate(reponse = factor(response, levels = c("n/e", "e/n", "n/n", "e/e")))
    xlab = "selected situations for QUDs if-p/will-q"
  }
  
  p <- df.wide %>% ggplot(aes(x=response, y=ratio , fill=response)) + 
    geom_bar(stat="identity", position=position_dodge()) +
    geom_label(aes(label=n)) +
    scale_fill_brewer(palette='Set2', name="response ifp_willq") +
    guides(fill=guide_legend(title.position="top")) +
    facet_wrap(~stimulus, nrow = 2) +
    theme(legend.position = "none") + #, axis.text.x = element_text(angle=10), 
    labs(y = "number participants", x=xlab)
  return(p)
}
p <- plot_empirical(data.critical)
p
if(save_plots) ggsave(here("results", "figs", "empirical-responses.pdf"), p, width=7, height=4)
```

Score participants: for each of the 4 critical stimuli, participants receive 1 point if they differentiate the QUDs ifp_willq, i.e. when they choose the exhaustive picture for one qud and the non-exhaustive for the other (independent of direction).
A score of 0 then means that the respective participant never made a difference between the two quds.

```{r}
df = data.critical %>% group_by(submissionID, picPair) %>% 
  dplyr::select(submissionID, picPair, question, response) %>% 
  filter(question != "neutral") %>% 
  pivot_wider(names_from = "question", values_from = "response") %>% 
  mutate(score = ifp != willq, score = as.integer(score))
df.scores = df %>% group_by(submissionID) %>%
  summarize(score = sum(score), .groups = "drop")
df.scores %>% ggplot(aes(x=score)) + geom_bar()

ids.score34 = df.scores %>% filter(score >= 3) %>% pull(submissionID)
ids.score234 = df.scores %>% filter(score >= 2) %>% pull(submissionID)
plot_empirical(data.critical %>% filter(submissionID %in% ids.score34)) +
  ggtitle("Participants with at most 1/4 ignorances of QUD")
plot_empirical(data.critical %>% filter(submissionID %in% ids.score234)) +
    ggtitle("Participants with at most 2/4 ignorances of QUD")

ids.score0 = df.scores %>% filter(score == 0) %>% pull(submissionID)

# those who never take QUD into account, do they switch between exh-exh and nonExh-nonExh
# or always give the same (identical) answer?
df.ignored_qud = df %>% filter(submissionID %in% ids.score0) %>% 
  group_by(submissionID, ifp, willq) %>% dplyr::count(name="nb_stimuli") %>%
  arrange(submissionID) %>% rename(selection = ifp) %>% ungroup() %>% 
  dplyr::select(-willq)

df.ignored_qud %>% group_by(selection, nb_stimuli) %>% dplyr::count() %>% 
  arrange(desc(n))

ids.noqud_nonExh1 = df.ignored_qud %>% 
  filter(nb_stimuli == 1 & selection == "non-exhaustive") %>% 
  pull(submissionID)

df %>%
  filter(submissionID %in% ids.noqud_nonExh1 & ifp=="non-exhaustive" & willq == "non-exhaustive")
```


Participants' scores for the neutral-question condition

```{r}
df = data.critical %>% group_by(submissionID) %>% 
  dplyr::select(submissionID, picPair, question, response) %>% 
  # filter(question == "neutral") %>% 
  mutate(score = response == "exhaustive", score = as.integer(score))
df.scores = df %>% summarize(score = sum(score), .groups = "drop")
df.scores %>% ggplot(aes(x=score)) + geom_bar()

ids.scores = df.scores %>% filter(score==12 | score==0) %>% 
  pull(submissionID)
plot_empirical(data.critical %>% filter(!submissionID %in% ids.scores)) +
    ggtitle("Participants who don't always choose exhaustive/non-exhaustive situation")

```

Plot empirical selection rates

```{r}
df <- data.critical.rate.picPair %>% 
  mutate(condition = factor(picPair), 
         question = as.character(question), 
         question = case_when(question == "willq" ~ "will-q",
                              question == "ifp" ~ "if-p", 
                              T ~ question),
         question = as.factor(question)) %>% 
  separate(col = picPair, into = c("exh_situation", "nonExh_situation"), sep="-") %>%
  mutate(exh_situation = str_sub(exh_situation, start=4),
         exh_situation = factor(exh_situation, levels = c("withDistractor", "w/oDistractor"))) %>%
  rename(QUD=question)

w_dodge = 0.25
p <- df %>% ggplot(aes(x=exh_situation, y=rate_exhaustive,
                       color=nonExh_situation,
                       group=interaction(QUD, nonExh_situation))) +
  geom_point(aes(shape = QUD), position = position_dodge(width=w_dodge)) +
  geom_errorbar(aes(ymin=ci.low, ymax=ci.up), width=0.1, 
                position = position_dodge(width=w_dodge)) +
  geom_line(position = position_dodge(width=w_dodge)) +
  labs(y = "selection rate exhaustive situation", x = "exhaustive situation") +
  scale_color_brewer(name = "non-exhaustive situation", palette = "Set2") +
  guides(color = guide_legend(title.position="top"), shape = guide_legend(title.position="top")) +
  annotate("text", x="withDistractor", y=0.35, label="C", hjust=1.5) +
  annotate("text", x="withDistractor", y=0.825, label="D", hjust=4.5) +
  annotate("text", x="w/oDistractor", y=0.4, label="A", hjust=-4) +
  annotate("text", x="w/oDistractor", y=0.87, label="B", hjust=-.8)

p
if(save_plots) ggsave(here("results", "figs", "empirical-responses-rates.pdf"), p, width=7, height=4)
```


```{r, results='hide'}
# model_path = here("results", "brms-model-3x2x2-filtered.rds")
model_path = here("results", "brms-model-3x2x2-newlabels.rds")

if(str_detect(model_path, "filtered")) {
  data.critical322 = data.critical.model %>% 
    filter(!submissionID %in% ids.scores)   
} else {
  data.critical322 = data.critical.model
}
data.critical322 = data.critical322 %>% 
  dplyr::select(submissionID, picPair, question, response, RT, picPair.long, y) %>% 
    mutate(exh = case_when(picPair %in% c("A", "B") ~ "NoDistr",
                                     picPair %in% c("C", "D") ~ "Distr"),
          nonExh = case_when(picPair %in% c("A", "C") ~ "Internal",
                             picPair %in% c("B", "D") ~ "External"), 
          exh = factor(exh, levels = c("Distr", "NoDistr")), 
          nonExh = factor(nonExh, levels = c("External", "Internal")))
if(file.exists(model_path)) {
  fit <- readRDS(model_path)
} else {
  fit <-
    brm(data = data.critical322,
        family = bernoulli,
        y ~ 1 +  exh * nonExh * question + (1 + exh + nonExh + question|submissionID),
        seed = 1, iter = 6000)
  saveRDS(fit, file=model_path)
}
fixef(fit)
pp_check(fit)
mcmc_plot(fit)

pp_check(fit, type = "stat", stat = 'mean', nsamples = 100)
```

```{r}
h1 = hypothesis(fit, "questionifp < questionwillq", class = "b")
h2 = hypothesis(fit, "questionifp + exhNoDistr:questionifp < questionwillq + exhNoDistr:questionwillq", 
                class = "b")
h3 = hypothesis(fit, "questionifp + nonExhInternal:questionifp < questionwillq + nonExhInternal:questionwillq", 
                class = "b")
h4 = hypothesis(fit, 
  "questionifp + exhNoDistr:nonExhInternal:questionifp + exhNoDistr:nonExhInternal + exhNoDistr:questionifp + nonExhInternal:questionifp < questionwillq + exhNoDistr:nonExhInternal:questionwillq + exhNoDistr:nonExhInternal + exhNoDistr:questionwillq + nonExhInternal:questionwillq", class = "b")

h1$hypothesis
h2$hypothesis
h3$hypothesis
h4$hypothesis
```

```{r}
posterior_draws = tidy_draws(fit)
```

Estimated main effect of QUD across exhaustive/nonExhaustive realizations

```{r}
samples = posterior_draws %>% 
  mutate(
    neutral_D = b_Intercept,
    neutral_B = b_Intercept +  `b_exhNoDistr`,
    neutral_C = b_Intercept + b_nonExhInternal ,
    neutral_A = b_Intercept + b_nonExhInternal + `b_exhNoDistr` + `b_exhNoDistr:nonExhInternal`,
    
    ifp_D = b_Intercept + b_questionifp,
    ifp_B = b_Intercept + b_questionifp + `b_exhNoDistr` + `b_exhNoDistr:questionifp`,
    ifp_C = b_Intercept + b_questionifp + b_nonExhInternal + `b_nonExhInternal:questionifp`,
    ifp_A = b_Intercept + b_questionifp + b_nonExhInternal + b_exhNoDistr +
      `b_exhNoDistr:nonExhInternal` + `b_exhNoDistr:questionifp` + `b_nonExhInternal:questionifp` +
      `b_exhNoDistr:nonExhInternal:questionifp`,
    willq_D = b_Intercept + b_questionwillq,
    willq_B = b_Intercept + b_questionwillq + b_exhNoDistr + `b_exhNoDistr:questionwillq`,
    willq_C = b_Intercept + b_questionwillq + b_nonExhInternal + `b_nonExhInternal:questionwillq`,
    willq_A = b_Intercept + b_questionwillq + b_nonExhInternal + b_exhNoDistr +
      `b_exhNoDistr:nonExhInternal` + `b_exhNoDistr:questionwillq` + `b_nonExhInternal:questionwillq` +
      `b_exhNoDistr:nonExhInternal:questionwillq`)

coeffs = samples %>% 
  transmute(questionneutral = (neutral_D + neutral_B + neutral_C + neutral_A)/4,
            questionifp = (ifp_A + ifp_B + ifp_C + ifp_D)/4,
            questionwillq = (willq_A + willq_B + willq_C + willq_D)/4) %>% 
  mutate(ifpsmaller = questionifp < questionwillq)

# posterior probability
mean(coeffs$ifpsmaller)

means = coeffs %>% summarize(mean_neutral = mean(questionneutral),
                             mean_ifp = mean(questionifp),
                             mean_willq = mean(questionwillq))

# cohen.d(coeffs$questionifp, coeffs$questionwillq)
p.mainquestion = coeffs %>% rowid_to_column() %>% 
  pivot_longer(cols=c(questionneutral, questionifp, questionwillq)) %>%
  ggplot(aes(x=name, y=value)) + 
  geom_boxplot() +
  labs(x = "estimated coefficient", y = "posterior samples") +
  scale_x_discrete(labels = c(
    questionneutral = parse(text=TeX("$\\hat{\\beta}_{neutral}$")),
    questionifp = parse(text=TeX("$\\hat{\\beta}_{if-p}$")), 
    questionwillq = parse(text=TeX("$\\hat{\\beta}_{will-q}$")))
  )
p.mainquestion
if(save_plots) ggsave(here("results", "figs", "main-effect-question.pdf"),
                      p.mainquestion, width=7, height=4)
```

Estimated main effect of the exhaustive and the non-exhaustive situation 

```{r}
samples.exh = posterior_draws %>% 
  mutate(
    exhDistr_Eneutral = b_Intercept,
    exhDistr_Eifp = b_Intercept + b_questionifp,
    exhDistr_Ewillq = b_Intercept + b_questionwillq,
    exhDistr_Ineutral = b_Intercept + b_nonExhInternal,
    exhDistr_Iifp = b_Intercept + b_nonExhInternal + b_questionifp + `b_nonExhInternal:questionifp`,
    exhDistr_Iwillq = b_Intercept + b_nonExhInternal + b_questionwillq + `b_nonExhInternal:questionwillq`,
    
    `exhNoDistr_Eneutral` = b_Intercept + `b_exhNoDistr`,
    `exhNoDistr_Eifp` = b_Intercept + `b_exhNoDistr` + b_questionifp + `b_exhNoDistr:questionifp`,
    `exhNoDistr_Ewillq`= b_Intercept + `b_exhNoDistr` + b_questionwillq + `b_exhNoDistr:questionwillq`,
    `exhNoDistr_Ineutral` = b_Intercept + `b_exhNoDistr` + b_nonExhInternal + `b_exhNoDistr:nonExhInternal`,
    `exhNoDistr_Iifp` = b_Intercept + `b_exhNoDistr` + b_nonExhInternal + b_questionifp + 
      `b_nonExhInternal:questionifp` + `b_exhNoDistr:nonExhInternal` + `b_exhNoDistr:questionifp` + 
      `b_exhNoDistr:nonExhInternal:questionifp`,
    exhNoDistr_Iwillq = b_Intercept + `b_exhNoDistr` + b_nonExhInternal + b_questionwillq + 
      `b_nonExhInternal:questionwillq` + `b_exhNoDistr:nonExhInternal` + `b_exhNoDistr:questionwillq` + 
      `b_exhNoDistr:nonExhInternal:questionwillq`)

coeffs.exh = samples.exh %>% 
  transmute(exhDistr = (exhDistr_Eneutral + `exhDistr_Eifp` + `exhNoDistr_Ewillq` + 
                      `exhDistr_Ineutral` + exhDistr_Iifp + exhDistr_Iwillq)/6,
            exhNoDistr = (`exhNoDistr_Eneutral` + `exhNoDistr_Eifp` + `exhNoDistr_Ewillq` + 
                      `exhNoDistr_Ineutral` + `exhNoDistr_Iifp` + `exhNoDistr_Iwillq`)/6)
means = coeffs.exh %>% summarize(mean_exhDistr = mean(exhDistr), `mean_exhNoDistr` = mean(`exhNoDistr`))

mean(coeffs.exh$exhDistr > 0)
coeffs.exh %>% pivot_longer(cols=everything()) %>% 
  ggplot(aes(x=value, color=name)) + geom_density()
p.exh = coeffs.exh %>% rowid_to_column() %>% 
  pivot_longer(cols=c(exhDistr, `exhNoDistr`)) %>%
  ggplot(aes(x=name, y=value)) + 
  geom_boxplot() +
  labs(x = "estimated coefficient", y = "posterior samples") +
  scale_x_discrete(labels = c(
    exhE = parse(text=TeX("$\\hat{\\beta}_{exhDistr}$")),
    exhNoDistr = parse(text=TeX("$\\hat{\\beta}_{exhNoDistr}$"))
    )
  )
p.exh
if(save_plots) ggsave(here("results", "figs", "main-effect-exhaustive.pdf"), p.exh, width=7, height=4)
```

1. non-exhaustive kept as external (1) and as internal (2): 
is there a difference between exhaustive = withDist or exhaustive = w/oDist ?

```{r}
# non-exhaustive: external
samples.exh %>% dplyr::select(exhDistr_Eneutral, `exhNoDistr_Eneutral`) %>% 
  transmute(`exhNoDistr_larger` = `exhNoDistr_Eneutral` > exhDistr_Eneutral) %>% 
  pull(`exhNoDistr_larger`) %>% mean()

# non-exhaustive: internal
samples.exh %>% dplyr::select(exhDistr_Ineutral, `exhNoDistr_Ineutral`) %>% 
  transmute(`exhNoDistr_larger` = `exhNoDistr_Ineutral` > exhDistr_Ineutral) %>% 
  pull(`exhNoDistr_larger`) %>% mean()
```

Estimated main effect of nonExhaustive realization

```{r}
samples.nonExh = posterior_draws %>% 
  mutate(
    nonExhE_Eneutral = b_Intercept,
    nonExhE_Eifp = b_Intercept + b_questionifp,
    nonExhE_Ewillq = b_Intercept + b_questionwillq,
    nonExhE_Ineutral = b_Intercept + b_exhNoDistr,
    nonExhE_Iifp = b_Intercept + b_exhNoDistr + b_questionifp + `b_exhNoDistr:questionifp`,
    nonExhE_Iwillq = b_Intercept + b_exhNoDistr + b_questionwillq + `b_exhNoDistr:questionwillq`,
    
    nonExhI_Eneutral = b_Intercept + b_nonExhInternal,
    nonExhI_Eifp = b_Intercept + b_nonExhInternal + b_questionifp + `b_nonExhInternal:questionifp`,
    nonExhI_Ewillq = b_Intercept + b_nonExhInternal + b_questionwillq + `b_nonExhInternal:questionwillq`,
    nonExhI_Ineutral = b_Intercept + b_exhNoDistr + b_nonExhInternal + `b_exhNoDistr:nonExhInternal`,
    nonExhI_Iifp = b_Intercept + b_exhNoDistr + b_nonExhInternal + b_questionifp + 
      `b_nonExhInternal:questionifp` + `b_exhNoDistr:nonExhInternal` + `b_exhNoDistr:questionifp` + 
      `b_exhNoDistr:nonExhInternal:questionifp`,
    nonExhI_Iwillq = b_Intercept + b_exhNoDistr + b_nonExhInternal + b_questionwillq + 
      `b_nonExhInternal:questionwillq` + `b_exhNoDistr:nonExhInternal` + `b_exhNoDistr:questionwillq` + 
      `b_exhNoDistr:nonExhInternal:questionwillq`)

coeffs.nonExh = samples.nonExh %>% 
  transmute(nonExhE = (nonExhE_Eneutral + nonExhE_Eifp + nonExhE_Ewillq + nonExhE_Ineutral + nonExhE_Iifp + nonExhE_Iwillq)/6,
            nonExhI = (nonExhI_Eneutral + nonExhI_Eifp + nonExhI_Ewillq + nonExhI_Ineutral + nonExhI_Iifp + nonExhI_Iwillq)/6)
means = coeffs.nonExh %>% 
  summarize(mean_nonExhE = mean(nonExhE), mean_nonExhI = mean(nonExhI))
coeffs.nonExh %>% pivot_longer(cols=everything()) %>% 
  ggplot(aes(x=value, color=name)) + geom_density()

p.nonExh = coeffs.nonExh %>% rowid_to_column() %>% 
  pivot_longer(cols=c(nonExhE, nonExhI)) %>%
  ggplot(aes(x=name, y=value)) + 
  geom_boxplot() +
  labs(x = "estimated coefficient", y = "posterior samples") +
  scale_x_discrete(labels = c(
    nonExhE = parse(text=TeX("$\\hat{\\beta}_{nonExhE}$")),
    nonExhI = parse(text=TeX("$\\hat{\\beta}_{nonExhI}$"))
    )
  )
p.nonExh
if(save_plots) ggsave(here("results", "figs", "main-effect-nonExhaustive.pdf"),
                      p.exh, width=7, height=4)
```

1. exhaustive:noDistr is very likely to yield a higher selection rate of the 
exhaustive picture when QUD is neutral.

2. exhaustive kept as Distr (1) and as NoDistr (2): is there a difference
between non-exhaustive = external or non-exhaustive = internal?

```{r}
# exhaustive: no Distractor
samples.nonExh %>% dplyr::select(nonExhE_Ineutral, nonExhI_Ineutral) %>% 
  transmute(nonExhE_larger = nonExhE_Ineutral > nonExhI_Ineutral) %>% 
  pull(nonExhE_larger) %>% mean()

# exhaustive: Distractor
samples.nonExh %>% dplyr::select(nonExhE_Eneutral, nonExhI_Eneutral) %>% 
  transmute(nonExhE_larger = nonExhE_Eneutral > nonExhI_Eneutral) %>% 
  pull(nonExhE_larger) %>% mean()
```

Estimated main effect of picture pairs

```{r}
samples.picPair = posterior_draws %>% 
  mutate(
    D = b_Intercept + (b_Intercept + b_questionifp) + (b_Intercept + b_questionwillq),
    C = b_Intercept + b_nonExhInternal + 
      (b_Intercept + b_nonExhInternal + b_questionifp + `b_nonExhInternal:questionifp`) +
      (b_Intercept + b_nonExhInternal + b_questionwillq + `b_nonExhInternal:questionwillq`),
    B = (b_Intercept + b_exhNoDistr) + 
      (b_Intercept + b_exhNoDistr + b_questionifp + `b_exhNoDistr:questionifp`) +
      (b_Intercept + b_exhNoDistr + b_questionwillq + `b_exhNoDistr:questionwillq`),
    A = (b_Intercept + b_exhNoDistr + b_nonExhInternal + `b_exhNoDistr:nonExhInternal`) +
      (b_Intercept + b_exhNoDistr + b_nonExhInternal + b_questionifp + 
      `b_nonExhInternal:questionifp` + `b_exhNoDistr:nonExhInternal` + `b_exhNoDistr:questionifp` + 
      `b_exhNoDistr:nonExhInternal:questionifp`) + 
      (b_Intercept + b_exhNoDistr + b_nonExhInternal + b_questionwillq + 
      `b_nonExhInternal:questionwillq` + `b_exhNoDistr:nonExhInternal` + `b_exhNoDistr:questionwillq` + 
      `b_exhNoDistr:nonExhInternal:questionwillq`)
  )

coeffs.picPair = samples.picPair %>% 
  transmute(D = D/3, C = C/3, B = B/3, A = A/3)
means = coeffs.picPair %>% 
  summarize(mean_D = mean(D), mean_C = mean(C), mean_B = mean(B), mean_A = mean(A))
coeffs.picPair %>% pivot_longer(cols=everything()) %>% 
  ggplot(aes(x=value, color=name)) + geom_density()

p.picPair = coeffs.picPair %>% rowid_to_column() %>% 
  pivot_longer(cols=c(D, C, B, A)) %>%
  ggplot(aes(x=name, y=value)) + 
  geom_boxplot() +
  labs(x = "estimated coefficient", y = "posterior samples") +
  scale_x_discrete(labels = c(
    A = parse(text=TeX("$\\hat{\\beta}_{A}$")),
    B = parse(text=TeX("$\\hat{\\beta}_{B}$")),
    C = parse(text=TeX("$\\hat{\\beta}_{C}$")),
    D = parse(text=TeX("$\\hat{\\beta}_{D}$"))
    )
  )
p.picPair
if(save_plots) ggsave(here("results", "figs", "main-effect-picPair.pdf"), 
                      p.picPair, width=7, height=4)
```

# Reaction times

Look at reaction times split across all picture pairs

```{r}
critical.RT = data.critical %>% 
  dplyr::select(submissionID, question, RT, picPair, y, selected_pic, id1, id2, 
                picPair.short) %>%
  mutate(visual_diff = case_when(picPair %in% c("B", "C") ~ T, 
                                 T ~ F)) %>% 
  group_by(question, picPair) 
critical.RT_means = critical.RT %>% 
  summarize(mean_RT = mean(RT), .groups = "drop_last")

bootstrap_RTs = group_map(critical.RT, function(df, df.group){
  bootstrap = map(seq(1, N), function(i){
    tibble(mean_RT = mean(sample(df$RT, n_participants, replace=T)))
  }) %>% bind_rows() %>% 
    add_column(picPair = df.group$picPair, question = df.group$question) %>% 
    arrange(mean_RT) # important!
  
  CI.bounds = bootstrap_bounds(bootstrap)
  ci.low = bootstrap[CI.bounds[["low"]], ]$mean_RT
  ci.up = bootstrap[CI.bounds[["up"]], ]$mean_RT
  bootstrap %>% add_column(ci.low=ci.low, ci.up=ci.up)
}) %>% bind_rows() %>% group_by(picPair, question)

bootstrap_RTs.CI.question_pic = bootstrap_RTs %>%
  dplyr::select(-mean_RT) %>% distinct()

left_join(critical.RT_means, bootstrap_RTs.CI.question_pic) %>% 
  ggplot(aes(x=mean_RT, y=picPair)) + 
  geom_bar(stat="identity") + 
  geom_errorbar(aes(xmin=ci.low, xmax=ci.up)) +
  facet_wrap(~question)
```

```{r}
p.rt = critical.RT %>%
  ggplot(aes(x=log(RT), color=picPair)) + geom_density() 
p.rt
p.rt + facet_wrap(~question)
if(save_plots) ggsave(here("results", "figs", "empiric-rts.pdf"), p.rt, width=7, height=4)
```
Plot means of reaction times differently 
concise plot without errorbars: (too large, if directly added into this plot, 
it becomes confusing)

```{r}
df.rt = critical.RT %>% 
  dplyr::select(submissionID, question, RT, picPair, picPair.short) %>% 
  #filter(!submissionID %in% ids.scores) %>% 
  separate(col = picPair, into = c("exh_situation", "nonExh_situation"), sep="-") %>% 
  mutate(exh_situation = str_sub(exh_situation, start=4),
         exh_situation = factor(exh_situation, 
                                levels = c("withDistractor", "w/oDistractor")))
df.rt_means = df.rt %>% 
  group_by(question, exh_situation, nonExh_situation, picPair.short) %>% 
  summarize(mean_rt = mean(RT), .groups = "drop_last") %>% 
  rename(QUD=question)
p <- df.rt_means %>% ggplot(aes(x=exh_situation, y=mean_rt, color=nonExh_situation)) +
  geom_point(aes(shape = QUD)) +
  geom_line(aes(group=interaction(QUD, nonExh_situation))) +
  labs(y = "average reaction time", x = "exhaustive situation") +
  scale_color_brewer(name = "non-exhaustive situation", palette = "Set2") +
  guides(color = guide_legend(title.position="top"), 
         shape = guide_legend(title.position="top")) +
  annotate("text", x=rep("withDistractor", 2), y=c(14000, 16000), 
                label=c("C", "D"), hjust=2) +
  annotate("text", x=rep("w/oDistractor", 2), y=c(13500, 15500), 
                label=c("A", "B"), hjust=-2)
p 
if(save_plots) ggsave(here("results", "figs", "reaction-times-233.pdf"), p, width=7, height=4)
```

```{r}
bootstrap_CIs = bootstrap_RTs.CI.question_pic %>% 
  separate(picPair, into=c("picPair.short", "tmp"), sep = ". ") %>% 
  dplyr::select(-tmp) %>% rename(QUD=question)

df.rt_means_with_CIs =left_join(df.rt_means, bootstrap_CIs) %>% 
  mutate(exh_situation = paste("exhaustive:", exh_situation))

p <- df.rt_means_with_CIs %>% 
  ggplot(aes(x=QUD, y=mean_rt, color=nonExh_situation)) +
  geom_point(position = position_dodge(width=.5)) + #shape = QUD)) +
  #geom_line(aes(group=interaction(QUD, nonExh_situation))) +
  geom_errorbar(position = position_dodge(width=.5),
                aes(ymin=ci.low, ymax=ci.up)) +
  labs(y = "average reaction time") + #, #x = "exhaustive situation") +
  scale_color_brewer(name = "non-exhaustive situation", palette = "Set2") +
  guides(color = guide_legend(title.position="top"), 
         shape = guide_legend(title.position="top")) +
  facet_wrap(~exh_situation)
p 
if(save_plots) ggsave(here("results", "figs", "reaction-times-233-with-errorbars.pdf"), p, width=7, height=4)

```

When the non-exhaustive picture is external (B + D) participants seem to respond 
more slowly than when the non-exhaustive picture is internal (A + C), when 
question=ifp or question=willq.

```{r}
model_path = here("results", "brms-model-rts233.rds")
#model_path = here("results", "brms-model-rts.rds")
if(file.exists(model_path)) {
  fit_rt <- readRDS(model_path)
} else {
  fit_rt <- brm(
    data = df.rt %>% 
      rename(exh=exh_situation, nonExh=nonExh_situation, picPair=picPair.short),
    family = lognormal(),
    RT ~ 1 + exh * nonExh * question + (1 + exh + nonExh + question|submissionID),
    #RT ~ 1 + picPair * question + (1 + picPair + question | submissionID),
    seed = 1, control = list(adapt_delta = 0.99), iter = 4000
  )
  saveRDS(fit_rt, file=model_path)
}
fixef(fit_rt)
pp_check(fit_rt)
mcmc_plot(fit_rt)

pp_check(fit_rt, type = "stat", stat = 'mean', nsamples = 100)

```

# Reaction times: 2x3x3 model 

1.-4. Reaction time is shorter for non-exhaustive internal than for nonExhaustive external when QUD=ifp or QUD=willq. 

```{r}
model_path = here("results", "brms-model-rts233.rds")
fit_rt_233 <- readRDS(model_path)
# 1. exhaustive:without Distractor
# 1.a QUD: ifp
hypothesis(fit_rt, "nonExhinternal + exhwDoDistractor:nonExhinternal + nonExhinternal:questionifp + exhwDoDistractor:nonExhinternal:questionifp < 0")

# 1.b QUD: willq
hypothesis(fit_rt, "nonExhinternal + exhwDoDistractor:nonExhinternal + nonExhinternal:questionwillq + exhwDoDistractor:nonExhinternal:questionwillq < 0")
# 3.c QUD: neutral
hypothesis(fit_rt, "nonExhinternal + exhwDoDistractor:nonExhinternal + exhwDoDistractor:nonExhinternal < 0")


# 2. exhaustive: with Distractor
# 2.a QUD: ifp
hypothesis(fit_rt, "nonExhinternal + nonExhinternal:questionifp + nonExhinternal:questionifp < 0")
# 2.b QUD: willq
hypothesis(fit_rt, "nonExhinternal + nonExhinternal:questionwillq + nonExhinternal:questionwillq < 0")
# 3.c QUD: neutral
hypothesis(fit_rt, "nonExhinternal < Intercept")

```


Estimated main effect of non-exhaustive across QUDs

```{r}
posterior_draws = tidy_draws(fit_rt_233)

samples = posterior_draws %>% 
  mutate(
    external_neutral_withD = b_Intercept,
    external_neutral_woD = b_Intercept + b_exhwDoDistractor,
    external_ifp_withD = b_Intercept + b_questionifp,
    external_ifp_woD = b_Intercept + b_questionifp + b_exhwDoDistractor + 
      `b_exhwDoDistractor:questionifp`, 
    external_willq_withD = b_Intercept + b_questionwillq,
    external_willq_woD = b_Intercept + b_questionwillq + b_exhwDoDistractor + 
      `b_exhwDoDistractor:questionwillq`,   
      
    internal_neutral_withD = b_Intercept + b_nonExhinternal,
    internal_neutral_woD = b_Intercept + b_nonExhinternal + b_exhwDoDistractor + 
      `b_exhwDoDistractor:nonExhinternal`,
    
    internal_ifp_withD = b_Intercept + b_nonExhinternal + b_questionifp + `b_nonExhinternal:questionifp`,
    internal_ifp_woD = b_Intercept + b_nonExhinternal + b_questionifp + b_exhwDoDistractor + 
      `b_exhwDoDistractor:questionifp` + `b_exhwDoDistractor:nonExhinternal` +`b_nonExhinternal:questionifp` + 
      `b_exhwDoDistractor:nonExhinternal:questionifp`,
    
    internal_willq_withD = b_Intercept + b_nonExhinternal + b_questionwillq + `b_nonExhinternal:questionwillq`,
    internal_willq_woD = b_Intercept + b_nonExhinternal + b_questionwillq + b_exhwDoDistractor + 
      `b_exhwDoDistractor:questionwillq` + `b_exhwDoDistractor:nonExhinternal` +`b_nonExhinternal:questionwillq` + `b_exhwDoDistractor:nonExhinternal:questionwillq`
    )

coeffs = samples %>% 
  transmute(nonExhinternal = (internal_neutral_withD + internal_neutral_woD +
                              internal_ifp_withD + internal_ifp_woD + 
                              internal_willq_withD + internal_willq_woD)/6,
            nonExhexternal = (external_neutral_withD + external_neutral_woD +
                              external_ifp_withD + external_ifp_woD + 
                              external_willq_withD + external_willq_woD)/6) %>% 
  mutate(internal_smaller = nonExhinternal < nonExhexternal)

# posterior probability
mean(coeffs$internal_smaller)

means = coeffs %>% summarize(mean_neutral = mean(questionneutral),
                             mean_ifp = mean(questionifp),
                             mean_willq = mean(questionwillq))

# cohen.d(coeffs$questionifp, coeffs$questionwillq)
p.main_nonExh = coeffs %>% rowid_to_column() %>% 
  pivot_longer(cols=c(nonExhinternal, nonExhexternal)) %>%
  ggplot(aes(x=name, y=value)) + 
  geom_boxplot() +
  labs(x = "estimated coefficient", y = "posterior samples") +
  scale_x_discrete(labels = c(
    nonExhinternal = parse(text=TeX("$\\hat{\\beta}_{nonExhinternal}$")),
    nonExhexternal = parse(text=TeX("$\\hat{\\beta}_{nonExhexternal}$"))
  ))
p.main_nonExh
```

# Analysis with 3x4 design
Reaction time is longer when at least one external picture is shown, that is
in picPair A responses are quickest

```{r, include=FALSE}
model_path = here("results", "brms-model-rts.rds")
fit_rt <- readRDS(model_path)

# question: neutral
hypothesis(fit_rt, "picPairIE > 0") # B
hypothesis(fit_rt, "picPairEI > 0") # C
hypothesis(fit_rt, "picPairEE > 0") # D

# question: ifp
hypothesis(fit_rt, "picPairIE + picPairIE:questionifp > 0")
hypothesis(fit_rt, "picPairEI + picPairEI:questionifp > 0") # posterior 0.44
hypothesis(fit_rt, "picPairEE + picPairEE:questionifp > 0")

# question: willq
hypothesis(fit_rt, "picPairIE + picPairIE:questionwillq > 0")
hypothesis(fit_rt, "picPairEI + picPairEI:questionwillq > 0") # posterior 0.65
hypothesis(fit_rt, "picPairEE + picPairEE:questionwillq > 0")
```


```{r}
samples_rt = tidy_draws(fit_rt) %>% 
  mutate(
    ifp_A = b_Intercept + b_questionifp,
    ifp_B = b_Intercept + b_questionifp + b_picPairB + `b_picPairB:questionifp`,
    ifp_C = b_Intercept + b_questionifp + b_picPairC + `b_picPairC:questionifp`,
    ifp_D = b_Intercept + b_questionifp + b_picPairD + `b_picPairD:questionifp`,
    willq_A = b_Intercept + b_questionwillq,
    willq_B = b_Intercept + b_questionwillq + b_picPairB + `b_picPairB:questionwillq`,
    willq_C = b_Intercept + b_questionwillq + b_picPairC + `b_picPairC:questionwillq`,
    willq_D = b_Intercept + b_questionwillq + b_picPairD + `b_picPairD:questionwillq`, 
    neutral_A = b_Intercept,
    neutral_B = b_Intercept + b_picPairB,
    neutral_C = b_Intercept + b_picPairC,
    neutral_D = b_Intercept + b_picPairD
    )

coeffs_rt_picPair = samples_rt %>% 
  mutate(picPairA = (neutral_A + ifp_A + willq_A)/3,
         picPairB = (neutral_B + ifp_B + willq_B)/3,
         picPairC = (neutral_C + ifp_C + willq_C)/3,
         picPairD = (neutral_D + ifp_D + willq_D)/3) 
# B and C faster than A/D?
coeffs_rt_picPair %>% 
  mutate(picPairB_vs_A = picPairB < picPairA,
         picPairC_vs_A = picPairC < picPairA,
         picPairB_vs_D = picPairB < picPairD,
         picPairC_vs_D = picPairC < picPairD
         ) %>%
  summarize(mean_B_vs_A = mean(picPairB_vs_A),
            mean_C_vs_A= mean(picPairC_vs_A),
            mean_B_vs_D = mean(picPairB_vs_D), 
            mean_C_vs_D = mean(picPairC_vs_D))

p.mainpicpair = coeffs_rt_picPair %>% 
  dplyr::select(picPairA, picPairB, picPairC, picPairD) %>% 
  # dplyr::select(contains("_B") | contains("_A")) %>% 
  pivot_longer(cols=everything(), names_to="picPair", values_to="value",
               names_prefix="picPair") %>%
  mutate(picPair = factor(picPair, levels = c("A", "C", "B", "D"))) %>% 
  ggplot(aes(x=picPair, y=value)) + 
  geom_boxplot() +
  labs(x = "estimated coefficient", y = "posterior samples") +
  scale_x_discrete(labels = c(B = parse(text=TeX("$\\hat{\\beta}_{B}$")), 
                              D = parse(text=TeX("$\\hat{\\beta}_{D}$")),
                              C = parse(text=TeX("$\\hat{\\beta}_{C}$")), 
                              A = parse(text=TeX("$\\hat{\\beta}_{A}$"))))
p.mainpicpair
if(save_plots) ggsave(here("results", "figs", "main-effect-picPair-rts.pdf"),
                      p.mainpicpair, width=7, height=4)

```

Look at reaction times when question=neutral for all four picture pairs. 
Stimulus A seems to be responded to most quickly.

```{r}
# neutral question condition:
samples_rt = tidy_draws(fit_rt) %>% 
  dplyr::select(c("b_Intercept", starts_with("b_picPair"))) %>% 
  pivot_longer(cols = everything())
p <- samples_rt %>% filter(!str_detect(name, ":") & name != "b_Intercept") %>% 
  ggplot(aes(x=value, fill=name)) + geom_histogram(alpha=0.75) +
  labs(x="posterior samples")
p
hypothesis(fit_rt, "picPairB > 0")
hypothesis(fit_rt, "picPairC > 0")
hypothesis(fit_rt, "picPairD > 0")
```

We speculated that pairs where only one of both pictures shows the third block (EI/IE) might yield quicker responses than than when the third block is absent or present in both pictures as participants might be inclined to select the picture on which only the blue and the green block are visible, which is a salient visual difference between both pictures.

```{r}
# add model data
```

## Training data

Sanity check: does ratio of correct answers increase with increasing trial numbers?

```{r}
data.train = cleaned_data %>% filter(type=="training") %>%
  mutate(correct=case_when(expected == response ~ T, T ~ F))

# ratio correct per trial number (different order per participant)
train.correct.nb = data.train %>% group_by(trial_number) %>% 
  summarize(ratio_correct = mean(correct))
train.correct.nb %>% 
  ggplot(aes(x=trial_number, y=ratio_correct)) + 
  geom_bar(stat="identity") + 
  scale_x_continuous(breaks=seq(1, 7))

# ratio correct per trial id
train.correct.id = data.train %>% group_by(id) %>% 
  summarize(ratio_correct = mean(correct))
train.correct.id %>% 
  ggplot(aes(x=id, y=ratio_correct)) + 
  geom_bar(stat="identity") +
  theme(axis.text.x=element_text(angle=90))
```

